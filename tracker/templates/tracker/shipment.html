{% extends 'tracker/index.html' %}
{% load static %}
{% load num_filters %}

{% block title %}
	<title>
		Shipment {{ shipment.shipid }}
	</title>
{% endblock title %}

{% block header %}
	<h1>Shipment {{ shipment.shipid }} &#8212; {{ shipment.owner.name }}, #{{ shipment.owner.acct }}</h1>
{% endblock header %}

{% block sub_nav %}

{% endblock sub_nav %}

{% block content %}

	<table>
		<thead>
		{% for item in headers %}
			<th>{{ item }}</th>
		{% endfor %}
{#		<th>Info</th>#}
		</thead>
		<tbody>
		<td><a href = "/accounts/{{ shipment.owner.acct }}">{{ shipment.owner.name }}</a></td>
		<td>#{{ shipment.owner.acct }}</td>
		<td>{{ shipment.palletized }}</td>
		{% if shipment.status != '4' %}
			<td>{{ shipment.arrival|date:"m-d-Y" }}</td>
		{% else %}
			<td>Departure: {{ shipment.departure|date:"m-d-Y" }}</td>
		{% endif %}
		<td>{{ shipment.labor_time }}</td>
		<td>{{ shipment.get_status_display }}</td>
		<td>{{ shipment.tracking_number }}</td>
{#		<td><a id = "shipFormToggle" href = "#" onclick = "javascript:togglePane('shipForm', 'shipFormToggle');">Hide#}
{#			Info</a>#}
{#		</tbody>#}
	</table>

	<br />
	<div class = "row">
		{% if user.is_authenticated %}
			<form id = "ship_info" method = "post" action = "/ship_info?shipid={{ shipment.shipid }}">
			{% csrf_token %}
		{% endif %}
		<div class = "col-2">
			<h3>Item List ({{ shipment.inventory_set.count }})</h3>
			<table class = "tableItem" style = "width: 90%;">
				<thead>
				<th class="checkbox"><input type = "checkbox" class = "checkbox" onclick = "javascript:checkAll(this);"></th>
				{% for item in item_headers %}
					<th>{{ item }}</th>
				{% endfor %}
				</thead>
				<tbody>
				{% for item in shipment.inventory_set.all %}
					<tr>
						<td id = "td_checkbox"><input type = "checkbox" class = "checkbox"
													  name = "item_{{ item.itemid }}"></td>
						<td id = "item_id">
							<a href = "/inventory?item={{ item.itemid }}">{{ item.itemid }}</a>
						</td>
						<td id = "item_volume">{{ item.volume|length:"2" }}</td>
						{% if not item.status == '4' %}
							<td id = "item_storage_fees">${{ item.storage_fees|length:"2" }}</td>
						{% else %}
							<td class = "inactive"></td>
						{% endif %}
						<td id = "item_status">{{ item.get_status_display }}</td>
					</tr>
				{% endfor %}
				</tbody>
			</table>
			<select name = "item_status" style = "margin-top:0.5rem;">
				<option value = "0">Inducted (0)</option>
				<option value = "1">Order Received (1)</option>
				<option value = "2">Order Started (2)</option>
				<option value = "3">Order Completed (3)</option>
				<option value = "4">Shipped (4)</option>
			</select>
		</div>

		<div class = "col-2">
			<div id = "shipForm" style = "display: block;">
				<h3>Information</h3>

				<div class = "col-2">
					Palletized: <input type = "checkbox" name = "palletized"
									   value = "{{ shipment.palletized }}" /><br />
					Labor time: <input type = "text" name = "labor_time" value = "{{ shipment.labor_time }}" /><br />
					Tracking #: <input type = "text" name = "tracking_number"
									   value = "{{ shipment.tracking_number }}" /><br />
					{% if shipment.status != '4' %}
						<a class = "btn" name = "submit" onclick = "verifyAllChecked('tableItem', 'ship_info');">Submit
							Information</a>
					{% else %}
						<a class = "btn disabled" name = "submit">Submit Information</a>
					{% endif %}
				</div>
				<div class = "col-2">
					Shipment notes:<br />
					<textarea name = "notes" id = "notes">{{ shipment.notes }}</textarea>
				</div>
			</div>
		</div>
		{% if user.is_authenticated %}
			</form>
		{% endif %}
	</div>

	<div class = "row">
		<hr align = "left" />
		<h3>Operation History ({{ shipment.shipoperation_set.count }})</h3>

		<table id="shipop_history">
			<thead>
				<tr>
					{% for item in shipop_headers %}
						<th>{{ item }}</th>
					{% endfor %}
				</tr>
			</thead>
			<tbody>
				{% for operation in shipment.shipoperation_set.all %}
					<tr>
						<td>{{ operation.id }}</td>
						<td>{{ operation.dt }}</td>
						<td>{{ operation.get_op_code_display }}</td>
						<td>{{ operation.user.get_full_name }}</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>

	<div class = "row">
		<hr align = "left" />
		<h3>Extras ({{ shipment.optextras_set.count }})</h3>
		{% if user.is_authenticated %}
			{% if shipment.status != '4' %}
				| <a href = "#">Add extra</a>
			{% else %}
				| <a href = "#" class = "disabled">Add extra</a>
			{% endif %}
		{% endif %}
		<table>
			<thead>
			<tr>
				<th onclick = "simpleTableToggle(this);"><a href = "#" class = "optextras_toggle"
															style = "color:white;text-decoration:none;">-</a></th>
				{% for item in extras_headers %}
					<th>{{ item }}</th>
				{% endfor %}
			</tr>
			</thead>
			<tbody>
			{% for extra in shipment.optextras_set.all %}
				<tr>
					<td>&nbsp;</td>
					<td>{{ extra.quantity }}</td>
					<td>${{ extra.unit_cost|length:"2" }}</td>
					<td>${{ extra.total_cost|length:"2" }}
					<td>{{ extra.description }}</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	</div>

	<script>
		var oldEvt = window.onload;
		window.onload = function () {
			if (oldEvt) oldEvt();

			var shipStatus = parseInt('{{ shipment.status }}');
			var s = document.getElementsByName('item_status')[0];

			// Set the form select widget to the current value + 1
			// Except if shipment.status = 4, disable the select widget
			if (shipStatus < 4) {
				s.selectedIndex = shipStatus + 1;
			} else {
				s.selectedIndex = 4;
				s.disabled = true;
			}

			// If the user isn't logged in or shipStatus = 4, disable the form elements
			var t = document.getElementsByClassName('float_user-greeting')[0].children[3].innerText;
			if (t == 'Log in' || shipStatus == 4) {
				disableElements('shipForm');
			}
		}
	</script>

{% endblock content %}
